{% extends "base.html" %}

{% block app_content %}
    <h1>{{ vote.name }}</h1>
        <font size="2">今日随机选项：</font>
        <font size="3" color="#a52a2a">{{ vote.get_today_random_option() }}</font>
    <br />
        <font size="2">今日投票人数：</font>
        <font size="3" color="#a52a2a">{{ vote.nb_voted_users_today() }}</font>
        <font size="2">({{ vote.string_names_has_voted_users_today() }})</font>
    <br />
        <font size="2">今日未投票人数：</font>
        <font size="3" color="#a52a2a">{{ vote.nb_not_voted_users_today() }}</font>
        <font size="2">({{ vote.string_names_not_has_voted_users_today() }})</font>
    <br />
    {% if vote.is_user_vote_today(current_user.id) %}
        <font size="2" color="#a9a9a9"
              style="cursor: pointer"
              onclick="delete_select({{ vote.id }}, {{ current_user.id }})">
            您今天已经参与了投票，点击取消投票
        </font>
    {% endif %}

    <br />
        <div class="input-group">
            <span class="input-group-addon">(☞ﾟヮﾟ)☞ </span>
            <input type="text"
                   id="search_text"
                   class="form-control"
                   placeholder="搜索店铺">
            <span class="input-group-addon">☜(ﾟヮﾟ☜)</span>
        </div>

        <div id="list_restaurant"
             class="input-group"
             style="display: none;">
        </div>
    <br />
        <div style="width: 100%;height:300px;">
        {# echarts图标 #}
            <div id="personal_vote" style="width: 35%;height:100%;display: inline-block"></div>
            <div id="echarts_main" style="width: 55%;height:100%;display: inline-block"></div>
        </div>

    <table class="table table-hover" id="table_restaurant">
        <tr>
            <td>选项</td>
            <td>投票人数</td>
        </tr>
    {% for option in vote.get_ordered_options() %}
            {% if vote.is_user_vote_today(current_user.id) %}
                <tr style="cursor:pointer;"
                    onclick="change_vote({{ vote.id }}, {{ option.id }}, {{ current_user.id }})">
            {% else %}
                <tr style="cursor: pointer"
                    onclick="vote_for_topic({{ vote.id }}, {{ option.id }}, {{ current_user.id }})">
            {% endif %}
                <td class="class_restaurant">
                    {{ option.id }}：{{ option.name }}
                </td>
                <td>
                    {{ option.nb_user_selected_today() }}
                    {% if option.is_user_selected_today(current_user.id) %}
                        (已投票)
                    {% endif %}
                </td>
            </tr>
    {% endfor %}
    </table>
{% endblock %}

{% block scripts %}
    {{ super() }}

    <script src="{{ url_for('static',filename='js/echarts.min.js') }}"></script>

    {# 每日投票人数统计 #}
    <script type="text/javascript">
        var oAjax = null;
        var postData = {"vote_id": "{{ vote.id }}"};
        postData="vote_id="+"{{ vote.id }}";

        try{
        　　oAjax = new XMLHttpRequest();
        }catch(e){
        　　oAjax = new ActiveXObject("Microsoft.XMLHTTP");
        }

        var url = '{{ url_for("data.vote", id=vote.id) }}';
        //post方式打开文件
        oAjax.open('post', url, true);

        //post相比get方式提交多了个这个
        oAjax.setRequestHeader("Content-type","application/x-www-form-urlencoded");

        //post发送数据
        oAjax.send(postData);
        oAjax.onreadystatechange = function(){
        　　//当状态为4的时候，执行以下操作
        　　if(oAjax.readyState === 4){
        　　　　try{
                    var echart_response = oAjax.responseText;
                    // 转化为json字符串
                    var obj = JSON.parse(echart_response);
                    // 转化为json对象
                    obj = eval("("+obj+")");

                    // 基于准备好的dom，初始化echarts实例
                    var myChart = echarts.init(document.getElementById('echarts_main'));
                    var date = obj.vote_date;
                    var data = obj.vote_cnt;
                    var max_cnt = obj.max_cnt;
                    var min_cnt = obj.min_cnt;
                    var interval = obj.interval;
{#                    var data = [1, 0, 3];#}

                    // 指定图表的配置项和数据
                    var option = {
                        tooltip: {
                            trigger: 'axis',
                            position: function (pt) {
                                return [pt[0], '10%'];
                            }
                        },
                        title: {
                            left: 'center',
                            text: '每日投票人数统计'
                        },
                        toolbox: {
                            feature: {
                                dataZoom: {
                                    yAxisIndex: 'none'
                                },
                                restore: {},
                                saveAsImage: {}
                            }
                        },
                        xAxis: {
                            type: 'category',
                            boundaryGap: false,
                            data: date
                        },
                        yAxis: {
                            type: 'value',
                            min: min_cnt,
                            max: max_cnt,
                            interval: interval,
                            boundaryGap: [0, '100%']
                        },
                        dataZoom: [{
                            type: 'inside',
                            start: 0,
                            end: 100
                        }, {
                            start: 0,
                            end: 100,
                            handleIcon: 'M10.7,11.9v-1.3H9.3v1.3c-4.9,0.3-8.8,4.4-8.8,9.4c0,5,3.9,9.1,8.8,9.4v1.3h1.3v-1.3c4.9-0.3,8.8-4.4,8.8-9.4C19.5,16.3,15.6,12.2,10.7,11.9z M13.3,24.4H6.7V23h6.6V24.4z M13.3,19.6H6.7v-1.4h6.6V19.6z',
                            handleSize: '80%',
                            handleStyle: {
                                color: '#fff',
                                shadowBlur: 3,
                                shadowColor: 'rgba(0, 0, 0, 0.6)',
                                shadowOffsetX: 2,
                                shadowOffsetY: 2
                            }
                        }],
                        series: [
                            {
                                name:'投票人数',
                                type:'line',
                                smooth:true,
                                symbol: 'none',
                                sampling: 'average',
                                itemStyle: {
                                    color: 'rgb(255, 70, 131)'
                                },
                                areaStyle: {
                                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                                        offset: 0,
                                        color: 'rgb(255, 158, 68)'
                                    }, {
                                        offset: 1,
                                        color: 'rgb(255, 70, 131)'
                                    }])
                                },
                                data: data
                            }
                        ]
                    };

                    // 使用刚指定的配置项和数据显示图表。
                    myChart.setOption(option);

                    oAjax.abort();

        　　　　}catch(e){
        　　　　　　alert('你访问的页面出错了');
        　　　　}
        　　}
        };
    </script>

    {# 每人投票数统计 #}
    <script type="text/javascript">
        var oAjax2 = null;
        var postData2 = {"vote_id": "{{ vote.id }}"};
        postData2="vote_id="+"{{ vote.id }}";

        try{
        　　oAjax2 = new XMLHttpRequest();
        }catch(e){
        　　oAjax2 = new ActiveXObject("Microsoft.XMLHTTP");
        }

        var url2 = '{{ url_for("data.personal_vote", id=vote.id) }}';
        //post方式打开文件
        oAjax2.open('post', url2, true);

        //post相比get方式提交多了个这个
        oAjax2.setRequestHeader("Content-type","application/x-www-form-urlencoded");

        //post发送数据
        oAjax2.send(postData2);
        oAjax2.onreadystatechange = function(){
        　　//当状态为4的时候，执行以下操作
        　　if(oAjax2.readyState === 4){
        　　　　try{
                    var echart_response2 = oAjax2.responseText;
                    // 接受一个 JSON 字符串并将其转换成一个 JavaScript 对象。
                    var obj2 = JSON.parse(echart_response2);
                    // 转化为json对象
                    obj2 = eval("("+obj2+")");

                    // 基于准备好的dom，初始化echarts实例
                    var myChart2 = echarts.init(document.getElementById('personal_vote'));
                    var data2 = obj2.data;
                    var names2 = obj2.list_name;

                    // 指定图表的配置项和数据
                    var option2 = {
                        title: {
                            text: '投票统计',
                            left: 0,
                            top: 10,
                            textStyle: {
                                color: '#323232'
                            }
                        },
                        tooltip: {
                            trigger: 'item',
                            backgroundColor : 'rgba(0,0,250,0.2)'
                        },
                        radar: {indicator : names2},
                        series : [{
                            name:'投票人',
                            type: 'radar',
                            symbol: 'none',
                            lineStyle: {
                                width: 1
                            },
                            emphasis: {
                                areaStyle: {
                                    color: 'rgba(0,250,0,0.3)'
                                }
                            },
                            data:[
                              {
                                value:data2
                              }
                            ]
                        }]
                    };

                    // 使用刚指定的配置项和数据显示图表。
                    myChart2.setOption(option2);

                    oAjax2.abort();

        　　　　}catch(e){
        　　　　　　alert('你访问的页面出错了');
        　　　　}
        　　}
        };


    </script>

    <script type="text/javascript">
        function vote_for_topic(vote_id, option_id, user_id) {
            window.location.href="/act/vote/add/"+vote_id+"/"+option_id+"/"+user_id;
        }
    </script>

    <script type="text/javascript">
        function delete_select(vote_id, user_id) {
            window.location.href="/act/vote/delete/"+vote_id+"/"+user_id;
        }
    </script>

    <script type="text/javascript">
        function change_vote(vote_id, option_id, user_id) {
            if (window.confirm("您确认要修改您的选择？")){
                window.location.href="/act/vote/change/"+vote_id+"/"+option_id+"/"+user_id;
            }
        }
    </script>

    <script type="text/javascript">
        function get_restaurant_id(restaurant_string) {
            return restaurant_string.split("：")[0]
        }

        function get_restaurant_name(restaurant_string) {
            return restaurant_string.split("：")[1]
        }
    </script>

    <script type="text/javascript">
        // 监听搜索框内容变化事件
        var node = document.querySelector('#search_text');
        var window_restaurant = document.querySelector('#list_restaurant');
        var inputLock = false;
        var mouseLock = false;
        var mouseId = -1;
        var current_choice = -1;
        var list_restaurant = document.getElementsByClassName("class_restaurant");

        // 找到包含特定字符串（搜索框输入字符串）的餐馆数量
        function nb_restaurant_concluding_string() {
            var restaurants = list_restaurant_concluding_string();
            var nb_result = restaurants.length;
            if (nb_result > 10){
                nb_result = 10;
            }
            if(nb_result === 1){
                nb_result = 2;
            }
            return nb_result
        }

        function change_vote_via_search_windows(){
            var vote_id = {{ vote.id }};
            var user_id = {{ current_user.id}};
            var option_id = document.getElementById("select_restaurant").value;
            option_id = option_id.trim();
            if (option_id){
                {% if vote.is_user_vote_today(current_user.id) %}
                    if (window.confirm("您确认要修改吗？")){
                        window.location.href="/act/vote/add_change/"+vote_id+"/"+option_id+"/"+user_id;
                    }
                {% else %}
                    window.location.href="/act/vote/add_change/"+vote_id+"/"+option_id+"/"+user_id;
                {% endif %}

            }
        }

        // 找到包含特定字符串（搜索框输入字符串）的餐馆列表
        function list_restaurant_concluding_string() {
            var results = [];
            var nb_result = 0;
            for (var i=0, len=list_restaurant.length; i<len; i++){
                var current_restaurant = list_restaurant[i].innerHTML;
                var current_restaurant_name = get_restaurant_name(current_restaurant);
                if (current_restaurant_name.search(node.value)!==-1){
                    results[nb_result] = current_restaurant;
                    nb_result += 1;
                }
            }
            return results
        }

        function focus_restaurant(restaurant_id) {
            if (current_choice !== restaurant_id){
                if (!mouseLock){
                    current_choice=restaurant_id;
                    mouseId = current_choice;
                    show_tips_windows()
                }
                else{
                    if (mouseId !== restaurant_id){
                        mouseLock = false;
                        current_choice=restaurant_id;
                        mouseId = current_choice;
                        show_tips_windows()
                    }
                }
            }
        }

        function show_tips_windows() {
            // 从页面中读取所有的餐馆列表，只打印名字中包含搜索框字符串的餐馆
            var nb_result = nb_restaurant_concluding_string();

            var restaurants = list_restaurant_concluding_string();

            var innerHTML = '<select class="form-control" id="select_restaurant" size="'+nb_result+'">';
            for (var i=0, len=restaurants.length; i<len; i++){
                var current_restaurant = restaurants[i];
                var current_restaurant_name = get_restaurant_name(current_restaurant);
                var current_restaurant_id = get_restaurant_id(current_restaurant);
                if (i===current_choice){
                    innerHTML += '<option value="'+current_restaurant_id+'" selected onmouseover="focus_restaurant('+i+')" onclick="change_vote_via_search_windows()">'+current_restaurant_name+'</option>'
                }
                else{
                    innerHTML = innerHTML + '<option value="'+current_restaurant_id+'" onmouseover="focus_restaurant('+i+')" onclick="change_vote_via_search_windows()">'+current_restaurant_name+'</option>'
                }
            }
            innerHTML += '</select>';
            window_restaurant.innerHTML=innerHTML;
            window_restaurant.style.display="block";
            if (nb_result===0){
                window_restaurant.style.display="none";
            }
        }

        $('#search_text').on('compositionstart', function () {
            inputLock = true
        }).on('compositionend',function () {
            inputLock = false
        }).on('input', function () {
          //定时器内才会生效 注意：定时器内this指向已发生改变
            setTimeout(function(){
                if (!inputLock){
                    current_choice = -1;
                    // 输入框为空的时候隐藏提示窗口
                    if (node.value.trim() === ""){
                        window_restaurant.style.display="none";
                    }
                    else{
{#                        var innerHTML = '<ul class="list-group">';#}
                        mouseLock = false;
                        show_tips_windows()
                    }
                }
            })
        }).on('keyup', function (e) {
            // 40 向下
            // 38 向上
            // 13 回车
            var nb_restaurant = nb_restaurant_concluding_string();
            if (e.keyCode ===40){
                mouseLock = true;
                current_choice = current_choice + 1;
                current_choice = current_choice % nb_restaurant;
                show_tips_windows()
            }
            if(e.keyCode === 38){
                if (current_choice === -1){
                    current_choice = 0
                }
                current_choice = current_choice + nb_restaurant - 1;
                current_choice = current_choice % nb_restaurant;
                mouseLock = true;
                show_tips_windows()
            }

            if(e.keyCode === 13){
                change_vote_via_search_windows()
            }
        });
    </script>
{% endblock %}